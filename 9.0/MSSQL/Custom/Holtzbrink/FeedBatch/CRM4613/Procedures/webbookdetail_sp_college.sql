IF EXISTS (SELECT * FROM sysobjects WHERE type = 'P' AND name = 'webbookdetail_sp_college')
BEGIN
  DROP  Procedure  dbo.webbookdetail_sp_college
END
GO


  CREATE 
    PROCEDURE webbookdetail_sp_college 
        @i_bookkey integer,
        @i_onixlevel integer,
        @FileName char(200),
        @i_websitekey integer
    AS
      /*
       -- Generated by SQL Server Migration Assistant for Oracle
       --  Please, contact SSMAHELP@microsoft.com or visit http://www.microsoft.com/sql/migration for more information.
       --*/
      BEGIN
          DECLARE 
            @cursor_row2$BISACDATACODE varchar(30),
            @cursor_row3$CHILDBOOKKEY integer,
            @cursor_row3a$PARENTBOOKKEY integer,
            @cursor_row4$FILETYPECODE integer,
            @cursor_row4$PATHNAME varchar(200),
            @cursor_row4$ELOQUENCEFIELDTAG varchar(100),
            @cursor_row4$EXTERNALCODE varchar(30),
            @cursor_row5$FILETYPECODE integer,
            @cursor_row5$PATHNAME varchar(255),
            @cursor_row5$ELOQUENCEFIELDTAG varchar(20),
            @cursor_row5$EXTERNALCODE varchar(20),
            @cursor_row6$CATEGORYCODE integer,
            @cursor_row6$DATADESC varchar(50),
            @cursor_row7$BESTPRICE integer,
            @cursor_row7$CURRENCYTYPE varchar(20),
            @cursor_row7$PRICETYPE varchar(20),
            @cursor_row8$CATEGORYDESCRIPTION varchar(255),
            @cursor_row8$CATEGORYCODE integer,
            @cursor_row8$CATEGORYEXTERNALCODE varchar(20),
            @cursor_row8$SUBCATDESCRIPTION varchar(255),
            @cursor_row8$SUBCATCODE integer,
            @cursor_row8$SUBCATEXTERNALCODE varchar(20),
            @cursor_row8$SUB2DESCRIPTION varchar(255),
            @cursor_row8$SUB2CATCODE integer,
            @cursor_row8$SUB2EXTERNALCODE varchar(20),
            @cursor_row9$PARENTBOOKKEY integer,
            @cursor_row9$CHILDBOOKKEY integer,
            @cursor_row9$SORTORDER integer,
            @cursor_row9$QUANTITY integer,
            @cursor_row10$CATEGORYDESCRIPTION varchar(255),
            @cursor_row10$CATEGORYCODE integer,
            @cursor_row10$CATEGORYEXTERNALCODE varchar(20),
            @cursor_row10$SUBCATDESCRIPTION varchar(255),
            @cursor_row10$SUBCATCODE integer,
            @cursor_row10$SUBCATEXTERNALCODE varchar(20),
            @cursor_row11$CATEGORYDESCRIPTION varchar(255),
            @cursor_row11$CATEGORYCODE integer,
            @cursor_row11$CATEGORYEXTERNALCODE varchar(20),
            @cursor_row11$SUBCATDESCRIPTION varchar(255),
            @cursor_row11$SUBCATCODE integer,
            @cursor_row11$SUBCATEXTERNALCODE varchar(20),
            @cursor_row12$AUTHORKEY integer,
            @cursor_row12$SORTORDER integer,
            @cursor_row12$AUTHORTYPE varchar(20),
            @cursor_row12$FIRSTNAME varchar(100),
            @cursor_row12$FIRSTNAMEU varchar(100),
            @cursor_row12$LASTNAME varchar(100),
            @cursor_row12$LASTNAMEU varchar(100),
            @cursor_row12$MIDDLENAME varchar(100),
            @cursor_row12$MIDDLENAMEU varchar(100),
            @cursor_row12$TITLE varchar(255),
            @cursor_row12$TITLEU varchar(255),
            @cursor_row12$AUTHORSUFFIX varchar(30),
            @cursor_row12$AUTHORDEGREE varchar(200),
            @cursor_row12$AFFNAME varchar(100),
            @cursor_row12$AFFTITLE varchar(100),
            @cursor_row13$BOOKKEY integer,
            @cursor_row13$MAJORBISACCATEGORYCODE integer,
            @cursor_row13$MAJORBISACCATEGORYDESC varchar(255),
            @cursor_row13$MINORBISACCATEGORYCODE integer,
            @cursor_row13$MINORBISACCATEGORYDESC varchar(255),
            @cursor_row13$SORTORDER integer,
            @c_dummy varchar(25),
            @c_bisacmediacode varchar(25),
            @c_bisacformatcode varchar(25),
            @c_onixformatcode varchar(25),
            @c_title varchar(255),
            @c_titleprefix varchar(100),
            @i_authortypecode integer,
            @i_authorsortorder integer,
            @i_authorcursorstatus integer,
            @c_authordisplayname varchar(100),
            @c_authordisplayname2 varchar(100),
            @c_copywright integer,
            @c_authorlastname varchar(100),
            @c_authorfirstname varchar(100),
            @c_authormiddlename varchar(100),
            @c_authortitle varchar(100),
            @c_onixauthortypecode varchar(10),
            @c_authortypedesc varchar(100),
            @i_editioncode integer,
            @c_editiondesc varchar(100),
            @i_seriescode integer,
            @c_seriesdesc varchar(100),
            @i_pagecount integer,
            @c_fullauthordisplayname varchar(255),
            @c_illus varchar(200),
            @c_bisacsubjectcode varchar(100),
            @i_subjectcursorstatus integer,
            @i_rownumber integer,
            @d_pubdate datetime,
            @c_pubdate varchar(8),
            @i_returncode integer,
            @c_bisacstatuscode varchar(10),
            @c_onixstatuscode varchar(10),
            @d_usretail numeric(10, 2),
            @i_agelow integer,
            @i_agelowupind integer,
            @i_agehigh integer,
            @i_agehighupind integer,
            @c_ean varchar(20),
            @c_trimsizewidth varchar(20),
            @c_trimsizelength varchar(20),
            @i_count integer,
            @i_count2 integer,
            @i_count3 integer,
            @c_postfix varchar(255),
            @lv_count integer,
            @lv_count2 integer,
            @lv_count3 integer,
            @c_isbn varchar(10),
            @c_isbn13 varchar(13),
            @c_subtitle varchar(255),
            @altformatdesc varchar(40),
            @c_filetype varchar(10),
            @c_fileformat varchar(10),
            @c_filelinktype varchar(10),
            @c_media varchar(40),
            @c_format varchar(40),
            @c_charfields varchar(100),
            @i_volume integer,
            @i_pricekey integer,
            @primarylastname varchar(100),
            @primaryfirstname varchar(100),
            @primarymiddlename varchar(100),
            @primarytitle varchar(100),
            @c_discountshort varchar(20),
            @c_discountlong varchar(40),
            @c_discountvista varchar(30),
            @c_formatalternatedesc1 varchar(255),
            @c_formatalternatedesc2 varchar(255),
            @c_allauthorlast varchar(1000),
            @c_allauthdisp varchar(1000),
            @c_allauthcomp varchar(1000),
            @c_authbest varchar(1000),
            @c_bestdisplay varchar(2000),
            @c_allauthcomp2 varchar(1000),
            @i_gen1ind integer,
            @c_gen1ind varchar(10),
            @c_signauthors varchar(100),
            @i_sigauthcount integer,
            @c_mediadesc varchar(100),
            @c_formatdesc varchar(100),
            @i_settypecode integer,
            @lv_output_string varchar(8000),
	    @v_lenght integer,
	    @v_start integer
      
          set @v_lenght = 8000
          SET @i_rownumber = 0
          SET @c_postfix = ''
          SET @lv_count = 0
          SET @lv_count2 = 0
          SET @lv_count3 = 0
          SET @c_isbn = ''
          SET @c_isbn13 = ''
          SET @c_subtitle = ''
          SET @c_filetype = ''
          SET @c_fileformat = ''
          SET @c_filelinktype = ''
          SET @c_media = ''
          SET @c_format = ''
          SET @c_charfields = ''
          SET @primarylastname = ''
          SET @primaryfirstname = ''
          SET @primarymiddlename = ''
          SET @primarytitle = ''
          SET @c_discountshort = ''
          SET @c_discountlong = ''
          SET @c_discountvista = ''
          SET @c_formatalternatedesc1 = ''
          SET @c_formatalternatedesc2 = ''
          SET @c_allauthorlast = ''
          SET @c_allauthdisp = ''
          SET @c_allauthcomp = ''
          SET @c_authbest = ''
          SET @c_bestdisplay = ''
          SET @c_allauthcomp2 = ''
          SET @c_gen1ind = ''
          SET @c_signauthors = ''
          SET @lv_output_string = ''
          BEGIN


            /* ***************************************** */
            /*  Output the beginning Product tag for this book  */
            /* ***************************************** */

            SET @lv_output_string = '<product>'

            --execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ***************************************** */
            /*  Output RecordReference - unique product number - we will use bookkey  */
            /* ***************************************** */

            SET @lv_output_string = ('<a001>' + isnull(CAST( CAST( @i_bookkey AS float) AS varchar(20)), '') + '</a001>')

            --execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ***************************************** */
            /*  Output NotificationType - set to '03' for confirmed book  */
            /* ***************************************** */

            SET @lv_output_string = '<a002>03</a002>'

            --execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  sp_AppendToFile @FileName, @lv_output_string

            --PRINT @lv_output_string

            /* ***************************************** */
            /*  Output b004 ISBN - ISBN 10 (without hyphens)  */
            /* ***************************************** */

            SET @i_count = 0

            SELECT @i_count = count( * )
              FROM ISBN
              WHERE ((ISBN.BOOKKEY = @i_bookkey) AND 
                      (ISNULL((ISBN.ISBN10 + '.'), '.') <> '.'))

            IF (@i_count > 0)
              BEGIN

                SELECT @c_isbn = ISBN.ISBN10
                  FROM ISBN
                  WHERE ((ISBN.BOOKKEY = @i_bookkey) AND 
                          (ISNULL((ISBN.ISBN10 + '.'), '.') <> '.'))

                SET @lv_output_string = ('<b004>' + isnull(@c_isbn, '') + '</b004>')

                execute  sp_AppendToFile @FileName, @lv_output_string

                --PRINT @lv_output_string

                /* ***************************************** */
                /*  Output <ISBN13> (ISBN with hyphens)      */
                /* ***************************************** */

                SET @i_count = 0

                SELECT @i_count = count( * )
                  FROM ISBN
                  WHERE ((ISBN.BOOKKEY = @i_bookkey) AND 
                          (ISNULL((ISBN.ISBN + '.'), '.') <> '.'))

                IF (@i_count > 0)
                  BEGIN
                    SELECT @c_isbn13 = ISBN.ISBN
                      FROM ISBN
                      WHERE ((ISBN.BOOKKEY = @i_bookkey) AND 
                              (ISNULL((ISBN.ISBN + '.'), '.') <> '.'))


                  END

                SET @lv_output_string = ('<isbn13>' + isnull(@c_isbn13, '') + '</isbn13>')

                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string

              END
            ELSE 
              BEGIN
                INSERT INTO FEEDERROR
                  (
                    FEEDERROR.ISBN, 
                    FEEDERROR.BATCHNUMBER, 
                    FEEDERROR.PROCESSDATE, 
                    FEEDERROR.ERRORDESC
                  )
                  VALUES 
                    (
                      'Not Avail', 
                      '32', 
                      getdate(), 
                      ('NO ISBN FOUND for bookkey ' + isnull(CAST( @i_bookkey AS varchar(20)), ''))
                    )
              END

            /* end isbn */

            /* ***************************************** */
            /*  Output b005 EAN - EAN13  */
            /* ***************************************** */

            SELECT @c_ean = isnull(ISBN.EAN, '')
              FROM ISBN
              WHERE (ISBN.BOOKKEY = @i_bookkey)

	    if @c_ean is not null or @c_ean <> '' 
	    BEGIN
                SET @lv_output_string = ('<b005>' + isnull(replace(@c_ean, '-', ''), '') + '</b005>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string
              END
            ELSE 
              BEGIN
                INSERT INTO FEEDERROR
                  (
                    FEEDERROR.ISBN, 
                    FEEDERROR.BATCHNUMBER, 
                    FEEDERROR.PROCESSDATE, 
                    FEEDERROR.ERRORDESC
                  )
                  VALUES 
                    (
                      'Not Avail', 
                      '32', 
                      getdate(), 
                      ('NO ISBN FOUND for bookkey ' + isnull(CAST( @i_bookkey AS varchar(100)), ''))
                    )
              END

            /* end isbn */

            /* ***************************************** */
            /*  Output <b012> Format Code   */
            /* ************************************************ */

            SET @i_count = 0
            SELECT @i_count = count( * )
              FROM BOOKDETAIL bd, GENTABLES g, SUBGENTABLES sg
              WHERE ((bd.BOOKKEY = @i_bookkey) AND 
                      (g.TABLEID = 312) AND 
                      (g.DATACODE = bd.MEDIATYPECODE) AND 
                      (sg.TABLEID = 312) AND 
                      (sg.DATACODE = bd.MEDIATYPECODE) AND 
                      (sg.DATASUBCODE = bd.MEDIATYPESUBCODE))


            IF (@i_count > 0)
              BEGIN

                SELECT @c_bisacformatcode = sg.BISACDATACODE
                  FROM BOOKDETAIL bd, GENTABLES g, SUBGENTABLES sg
                  WHERE ((bd.BOOKKEY = @i_bookkey) AND 
                          (g.TABLEID = 312) AND 
                          (g.DATACODE = bd.MEDIATYPECODE) AND 
                          (sg.TABLEID = 312) AND 
                          (sg.DATACODE = bd.MEDIATYPECODE) AND 
                          (sg.DATASUBCODE = bd.MEDIATYPESUBCODE))

                SET @lv_output_string = ('<b012>' + isnull(@c_bisacformatcode, '') + '</b012>')

                --execute  sp_AppendToFile @FileName, @lv_output_string
		execute  sp_AppendToFile @FileName, @lv_output_string

                --PRINT @lv_output_string

              END

            /* *************************************** */
            /* ********* OUTPUT TITLE TAGS *********** */
            /* *************************************** */

            SET @lv_count = 0

            SELECT @lv_count = count( * )
              FROM BOOKDETAIL
              WHERE (BOOKDETAIL.BOOKKEY = @i_bookkey)

            IF (@lv_count > 0)
              BEGIN

                SELECT @c_titleprefix = IsNull(titleprefix, ' ')
                  FROM BOOKDETAIL bd
                  WHERE (bd.BOOKKEY = @i_bookkey)

		if @c_titleprefix is not null BEGIN
		set @c_titleprefix = ltrim(rtrim(@c_titleprefix))
		end

                IF (@lv_count = 0)
                  SET @c_titleprefix = ''

                SELECT @lv_count3 = count( * )
                  FROM BOOK
                  WHERE (BOOK.BOOKKEY = @i_bookkey)

                IF (@lv_count3 > 0)
                  BEGIN
                    SELECT @c_title = ltrim(rtrim(@c_title))
                      FROM BOOK
                      WHERE (BOOK.BOOKKEY = @i_bookkey)

                  END
                ELSE 
                  BEGIN

                    INSERT INTO FEEDERROR
                      (
                        FEEDERROR.ISBN, 
                        FEEDERROR.BATCHNUMBER, 
                        FEEDERROR.PROCESSDATE, 
                        FEEDERROR.ERRORDESC
                      )
                      VALUES 
                        (
                          @c_isbn, 
                          '32', 
                          getdate(), 
                          ('NO Book row found for bookkey ' + isnull(CAST( @i_bookkey AS varchar(20)), ''))
                        )

                    SET @c_title = ''

                  END

                /* *************************************** */

                /* * Output b028  Title w. prefix * */

                /* *************************************** */

                SET @lv_output_string = ('<b028><![CDATA[' + isnull(@c_titleprefix, '') + ' ' + isnull(@c_title, '') + ']]></b028>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string

                /* *************************************** */
                /* * Output b028U  Title (UPPERCASE)* */
                /* *************************************** */

                SET @lv_output_string = ('<b028U><![CDATA[' + isnull(upper(@c_title), '') + ']]></b028U>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string

                /* *************************************** */
                /* * Output b031 Title Without Prefix * */
                /* *************************************** */

                SET @lv_output_string = ('<b031><![CDATA[' + isnull(@c_title, '') + ']]></b031>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string

                /* *************************************** */
                /* * Output b030 Title Prefix * */
                /* *************************************** */

                SET @lv_output_string = ('<b030><![CDATA[' + isnull(@c_titleprefix, '') + ']]></b030>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string
              END

            /* *************************************** */
            /* * Output b029 Subtitle * */
            /* *************************************** */

            IF (@lv_count3 > 0)
              BEGIN
                SELECT @c_subtitle = isnull(SUBTITLE, '')
                  FROM BOOK
                  WHERE (BOOK.BOOKKEY = @i_bookkey)

       		set @c_subtitle =  rtrim(ltrim(@c_subtitle))

                IF len(@c_subtitle) > 0
                  BEGIN

                    SET @lv_output_string = '<b029><![CDATA[' + @c_subtitle + ']]></b029>'
                    execute  sp_AppendToFile @FileName, @lv_output_string
                    --PRINT @lv_output_string

                    SET @lv_output_string = '<b029U><![CDATA[' + upper(@c_subtitle) + ']]></b029U>'
                    execute  sp_AppendToFile @FileName, @lv_output_string
                    --PRINT @lv_output_string
                  END
              END

            /* *************************************** */

            /* * output AUthor Information  * */

            /* *************************************** */

            SET @c_allauthorlast = ''
            SET @c_allauthdisp = ''
            SET @c_allauthcomp = ''
            SET @c_authbest = ''

            SELECT 
                @c_allauthorlast = isnull(WHTITLEINFO.ALLAUTHORLASTNAME, ''),
                @c_allauthdisp = isnull(WHTITLEINFO.ALLAUTHORDISPLAYNAME, ''),
                @c_allauthcomp = isnull(WHTITLEINFO.ALLAUTHORCOMPLETENAME, ''),
                @c_authbest = isnull(WHTITLEINFO.BESTAUTHORDISPLAYNAME, '')
              FROM WHTITLEINFO
              WHERE (WHTITLEINFO.BOOKKEY = @i_bookkey)


            SET @lv_output_string = '<allauthorlastnames><![CDATA[' + rtrim(@c_allauthorlast) + ']]></allauthorlastnames>'
            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            SET @lv_output_string = '<allauthordisplaynames><![CDATA[' + rtrim(@c_allauthdisp) + ']]></allauthordisplaynames>'
            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            SET @lv_output_string = '<allauthorcompletenames><![CDATA[' + rtrim(@c_allauthcomp)  + ']]></allauthorcompletenames>'
            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            SET @lv_output_string = '<bestauthordisplayname><![CDATA[' + rtrim(@c_authbest) + ']]></bestauthordisplayname>'
            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* *************************************** */

            /* * Output b061 NumberOfPages - Page Count              * */

            /* *************************************** */

            SET @lv_count2 = 0

            /* 10-02-02  use tentativepagecount if actual not present */

            SELECT @lv_count2 = count( * )
              FROM PRINTING
              WHERE ((PRINTING.BOOKKEY = @i_bookkey) AND 
                      (PRINTING.PRINTINGKEY = 1))


            IF (@lv_count2 > 0)
              BEGIN

                SELECT @i_pagecount = isnull(PRINTING.PAGECOUNT, PRINTING.TENTATIVEPAGECOUNT)
                  FROM PRINTING
                  WHERE ((PRINTING.BOOKKEY = @i_bookkey) AND 
                          (PRINTING.PRINTINGKEY = 1))


                IF ((@i_pagecount IS NOT NULL) AND 
                        (@i_pagecount > 0))
                  BEGIN
                    SET @lv_output_string = ('<b061>' + isnull(CAST( @i_pagecount AS varchar(10)), '') + '</b061>')
                    execute  sp_AppendToFile @FileName, @lv_output_string
                    --PRINT @lv_output_string
                  END
            END

                /* *************************************** */
                /* * Output b062 IllustrationsNotes - Insert/Illus              * */
                /* *************************************** */

                SELECT @c_illus = isnull(actualinsertillus,estimatedinsertillus)
                  FROM PRINTING
                  WHERE ((PRINTING.BOOKKEY = @i_bookkey) AND 
                          (PRINTING.PRINTINGKEY = 1))

                set @c_illus = ISNULL(@c_illus, '')

                IF len(@c_illus) > 0
                  BEGIN
                    SET @lv_output_string = ('<b062><![CDATA[' + isnull(@c_illus, '') + ']]></b062>')
                    execute  sp_AppendToFile @FileName, @lv_output_string
                    --PRINT @lv_output_string

                  END

            /* *************************************** */
            /* * Output b079 ImprintName              * */
            /* *************************************** */

            SELECT @lv_output_string = '<b079><![CDATA[' + isnull(oe.ORGENTRYDESC, '') + ']]></b079>'
              FROM ORGENTRY oe, BOOKORGENTRY bo
              WHERE bo.BOOKKEY = @i_bookkey AND 
                    bo.ORGLEVELKEY = 5 AND 
                    oe.ORGENTRYKEY = bo.ORGENTRYKEY

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* *************************************** */
            /* * Output b081 PublisherName              * */
            /* *************************************** */

            SELECT @lv_output_string = ('<b081><![CDATA[' + isnull(oe.ORGENTRYDESC, '') + ']]></b081>')
              FROM ORGENTRY oe, BOOKORGENTRY bo
              WHERE ((bo.BOOKKEY = @i_bookkey) AND 
                      (bo.ORGLEVELKEY = 3) AND 
                      (oe.ORGENTRYKEY = bo.ORGENTRYKEY))

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* *************************************** */
            /* * Output b003 PublicationDate         * */
            /* *************************************** */

            SET @i_count = 0
            SELECT @i_count = count( * )
              FROM BOOKDATES
              WHERE ((BOOKDATES.BOOKKEY = @i_bookkey) AND 
                      (BOOKDATES.PRINTINGKEY = 1) AND 
                      (BOOKDATES.DATETYPECODE = 8))


            IF (@i_count > 0)
              BEGIN
                SELECT @c_pubdate = CONVERT(varchar(10), BOOKDATES.BESTDATE, 112)
                  FROM BOOKDATES
                  WHERE ((BOOKDATES.BOOKKEY = @i_bookkey) AND 
                          (BOOKDATES.PRINTINGKEY = 1) AND 
                          (BOOKDATES.DATETYPECODE = 8))

                SET @lv_output_string = ('<b003>' + isnull(@c_pubdate, '') + '</b003>')
                execute  sp_AppendToFile @FileName, @lv_output_string
               --PRINT @lv_output_string
              END
            ELSE 
              IF (@lv_count2 > 0)
                BEGIN

                  /*
                   -- ** Actual or Estimated Pub Date does not exist, Try Pub Year from Printing. Pub Year is set in Java Import
                   --      to Pub Month + Pub Year, with day set to '01'. i.e. 03/01/2001 **
                   --*/
                  SELECT @c_pubdate = CONVERT(varchar(10), PRINTING.PUBMONTH, 112)
                    FROM PRINTING
                    WHERE ((PRINTING.BOOKKEY = @i_bookkey) AND 
                            (PRINTING.PRINTINGKEY = 1))

		 if  @c_pubdate  Is not Null 
                    BEGIN
                      SET @lv_output_string = ('<b003>' + isnull(@c_pubdate, '') + '</b003>')
                      execute  sp_AppendToFile @FileName, @lv_output_string
                      --PRINT @lv_output_string
                    END
                END

            /* * end pub date * */

            /* ***************************************** */
            /*  COPYRIGHT YEAR    */
            /* ************************************************ */

            SELECT @c_copywright = isnull(WHTITLECLASS.COPYRIGHTYEAR, '')
              FROM WHTITLECLASS
              WHERE (WHTITLECLASS.BOOKKEY = @i_bookkey)

            SET @lv_output_string = ('<b087>' + isnull(CAST( @c_copywright AS varchar(20)), '') + '</b087>')
            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ***************************************** */
            /*  MEDIA DESCRIPTION   */
            /* ************************************************ */

                SELECT @c_mediadesc = g.DATADESC
                  FROM BOOKDETAIL bd, GENTABLES g, SUBGENTABLES sg
                  WHERE ((bd.BOOKKEY = @i_bookkey) AND 
                          (g.TABLEID = 312) AND 
                          (g.DATACODE = bd.MEDIATYPECODE) AND 
                          (sg.TABLEID = 312) AND 
                          (sg.DATACODE = bd.MEDIATYPECODE) AND 
                          (sg.DATASUBCODE = bd.MEDIATYPESUBCODE))


                SET @lv_output_string = ('<mediadesc>' + isnull(@c_mediadesc, '') + '</mediadesc>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string


            /* ***************************************** */
            /*  FORMAT DESCRIPTION   */
            /* ************************************************ */

            SET @i_count = 0

            SELECT @i_count = count( * )
              FROM BOOKDETAIL bd, GENTABLES g, SUBGENTABLES sg
              WHERE ((bd.BOOKKEY = @i_bookkey) AND 
                      (g.TABLEID = 312) AND 
                      (g.DATACODE = bd.MEDIATYPECODE) AND 
                      (sg.TABLEID = 312) AND 
                      (sg.DATACODE = bd.MEDIATYPECODE) AND 
                      (sg.DATASUBCODE = bd.MEDIATYPESUBCODE))

            IF (@i_count > 0)
              BEGIN

                SELECT @c_formatdesc = sg.DATADESC
                  FROM BOOKDETAIL bd, GENTABLES g, SUBGENTABLES sg
                  WHERE ((bd.BOOKKEY = @i_bookkey) AND 
                          (g.TABLEID = 312) AND 
                          (g.DATACODE = bd.MEDIATYPECODE) AND 
                          (sg.TABLEID = 312) AND 
                          (sg.DATACODE = bd.MEDIATYPECODE) AND 
                          (sg.DATASUBCODE = bd.MEDIATYPESUBCODE))

                SET @lv_output_string = ('<formatdesc>' + isnull(@c_formatdesc, '') + '</formatdesc>')

                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string

              END

            /* ***************************************** */
            /*  LANGUAGE   */
            /* ************************************************ */

            SET @i_count = 0

            SELECT @i_count = count( * )
              FROM BOOKDETAIL b, GENTABLES g
              WHERE ((g.TABLEID = 318) AND 
                      (b.LANGUAGECODE = g.DATACODE) AND 
                      (b.BOOKKEY = @i_bookkey))

            IF (@i_count > 0)
              BEGIN
                SELECT @c_charfields = g.DATADESC
                  FROM BOOKDETAIL b, GENTABLES g
                  WHERE ((g.TABLEID = 318) AND 
                          (b.LANGUAGECODE = g.DATACODE) AND 
                          (b.BOOKKEY = @i_bookkey))


                    SET @lv_output_string = ('<language><![CDATA[' + isnull(@c_charfields, '') + ']]></language>')
                    execute  sp_AppendToFile @FileName, @lv_output_string
              END

            /* ***************************************** */
            /*  PRIMARY AUTHOR NAME  */
            /* ************************************************ */

            SET @i_count = 0

            SELECT @i_count = count( * )
              FROM BOOKAUTHOR ba, AUTHOR a
              WHERE ((ba.BOOKKEY = @i_bookkey) AND 
                      (ba.AUTHORKEY = a.AUTHORKEY) AND 
                      (ba.SORTORDER = 1))

            IF (@i_count > 0)
              BEGIN
                SELECT @primaryfirstname = isnull(a.FIRSTNAME , ''), @primarylastname = isnull(LASTNAME, ''), @primarymiddlename = isnull(a.MIDDLENAME, '')
                  FROM BOOKAUTHOR ba, AUTHOR a
                  WHERE ((ba.BOOKKEY = @i_bookkey) AND 
                          (ba.AUTHORKEY = a.AUTHORKEY) AND 
                          (ba.SORTORDER = 1))
                ORDER BY ba.SORTORDER
              END

            IF len(@primaryfirstname) > 0
              BEGIN
                SET @lv_output_string = ('<FN><![CDATA[' + isnull(upper(@primaryfirstname), '') + ']]></FN>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string
              END

            IF len(@primarylastname) > 0
              BEGIN
                SET @lv_output_string = ('<LN><![CDATA[' + isnull(upper(@primarylastname), '') + ']]></LN>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string
              END

            IF len(@primarymiddlename) > 0
              BEGIN
                SET @lv_output_string = ('<MN><![CDATA[' + isnull(upper(@primarymiddlename), '') + ']]></MN>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string
              END

            /* ***************************************** */
            /*  TRIM SIZE  */
            /* ************************************************ */

            SET @lv_count2 = 0
            SELECT @lv_count2 = count( * )
              FROM PRINTING
              WHERE ((PRINTING.BOOKKEY = @i_bookkey) AND 
                      (PRINTING.PRINTINGKEY = 1))
            IF (@lv_count2 > 0)
              BEGIN

                SET @c_postfix = ''

                /* 10-02-02  per bruce use esttrim if actual not present */
                SELECT @c_trimsizewidth =  isnull(trimsizewidth,esttrimsizewidth), @c_trimsizelength = isnull(trimsizelength,esttrimsizelength)
                  FROM PRINTING
                  WHERE ((PRINTING.BOOKKEY = @i_bookkey) AND 
                          (PRINTING.PRINTINGKEY = 1))

		set @c_trimsizewidth = IsNull(@c_trimsizewidth, '')
		set @c_trimsizelength = IsNull(@c_trimsizewidth, '')

                IF len(@c_trimsizewidth) > 0
                  IF len(@c_trimsizelength) > 0
                    BEGIN
                      SET @c_postfix = ltrim(rtrim(@c_trimsizewidth)) + ' x ' + ltrim(rtrim(@c_trimsizelength))
                      SET @lv_output_string = ('<TrimSize><![CDATA[' + isnull(@c_postfix, '') + ']]></TrimSize>')
                      execute  sp_AppendToFile @FileName, @lv_output_string
                    END
              END

            /* *************************************** */
            /* * Public Imprint * */
            /* *************************************** */

            SELECT @lv_output_string = ('<publicimprint><![CDATA[' + isnull(oe.ORGENTRYDESC, '') + ']]></publicimprint>')
              FROM ORGENTRY oe, BOOKORGENTRY bo
              WHERE ((bo.BOOKKEY = @i_bookkey) AND 
                      (bo.ORGLEVELKEY = 5) AND 
                      (oe.ORGENTRYKEY = bo.ORGENTRYKEY))

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ***************************************** */
            /*  DISCOUNT CODES  */
            /* ************************************************ */

            SET @c_discountshort = ''
            SET @i_count = 0
            SELECT @i_count = count( * )
              FROM GENTABLES g, BOOKDETAIL b
              WHERE ((b.BOOKKEY = @i_bookkey) AND 
                      (g.DATACODE = b.DISCOUNTCODE) AND 
                      (g.TABLEID = 459))

            IF (@i_count > 0)
              BEGIN
                SELECT @c_discountlong = g.DATADESC, @c_discountshort = g.DATADESCSHORT, @c_discountvista = g.EXTERNALCODE
                  FROM GENTABLES g, BOOKDETAIL b
                  WHERE ((b.BOOKKEY = @i_bookkey) AND 
                          (g.DATACODE = b.DISCOUNTCODE) AND 
                          (g.TABLEID = 459))

                SET @lv_output_string = ('<discountcodelong><![CDATA[' + isnull(@c_discountlong, '') + ']]></discountcodelong>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string

                SET @lv_output_string = ('<discountcodevista><![CDATA[' + isnull(@c_discountvista, '') + ']]></discountcodevista>')
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string
              END

            /* *************************************** */
            /* * Output series composite            * */
            /* *************************************** */
            SET @c_charfields = ''
            SELECT @i_seriescode = BOOKDETAIL.SERIESCODE, @i_volume = BOOKDETAIL.VOLUMENUMBER
              FROM BOOKDETAIL
              WHERE (BOOKDETAIL.BOOKKEY = @i_bookkey)

            IF (@i_seriescode IS NULL)
              SET @i_seriescode = 0

            IF (@i_seriescode > 0)
              BEGIN

		  select @c_seriesdesc = IsNull(alternatedesc1,datadesc), @c_charfields = rtrim(convert(varchar(100),numericdesc1))
                  FROM GENTABLES
                  WHERE ((GENTABLES.TABLEID = 327) AND 
                          (GENTABLES.DATACODE = @i_seriescode))

		  if @c_charfields is null begin
		   set @c_charfields = ''
		  end
		  if @c_charfields = '0' begin
		   set @c_charfields = ''
		  end
		  if @i_volume is null begin
		   set @i_volume = 0
		  end

                SET @lv_output_string = '<series>'
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string

                /* * b018 TitleOfSeries ** */
                SET @lv_output_string = ('<b018><![CDATA[' + isnull(@c_seriesdesc, '') + ']]></b018>')
                execute  sp_AppendToFile @FileName, @lv_output_string
               --PRINT @lv_output_string

                IF (@i_volume > 0)
                  IF len(@c_charfields) > 0
                    BEGIN

                      SET @lv_output_string = ('<b019>No. ' + isnull(CAST( @i_volume AS varchar(100)), '') + ' of ' + isnull(@c_charfields, '') + '</b019>')
                      execute  sp_AppendToFile @FileName, @lv_output_string
                      --PRINT @lv_output_string
                    END
                  ELSE 
                    BEGIN
                      SET @lv_output_string = ('<b019>No. ' + isnull(CAST( @i_volume AS varchar(100)), '') + '</b019>')
                      execute  sp_AppendToFile @FileName, @lv_output_string
                      --PRINT @lv_output_string
                    END

                SET @lv_output_string = '</series>'
                execute  sp_AppendToFile @FileName, @lv_output_string
                --PRINT @lv_output_string
              END
            ELSE 
              BEGIN
                INSERT INTO FEEDERROR
                  (
                    FEEDERROR.ISBN, 
                    FEEDERROR.BATCHNUMBER, 
                    FEEDERROR.PROCESSDATE, 
                    FEEDERROR.ERRORDESC
                  )
                  VALUES 
                    (
                      @c_isbn, 
                      '32', 
                      getdate(), 
                      ('NO BOOKDETAIL ROW, missing format etc. for bookkey ' + isnull(CAST( @i_bookkey AS varchar(30)), ''))
                    )
                IF (@@TRANCOUNT > 0)
                    COMMIT WORK
              END

            /* bookdetail */

            /* ************************************* */
            /* * AVAILABILITY STATUS CODE   * */
            /* ************************************* */

            SELECT @lv_output_string = '<supplydetail><j141>' + isnull(WHTITLECLASS.BISACSTATUSSHORT, '') + '</j141></supplydetail>'
              FROM WHTITLECLASS
              WHERE (WHTITLECLASS.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ************************************* */
            /* * PROJECT ISBN   * */
            /* ************************************* */

            SELECT @lv_output_string = '<projectisbn>' + isnull(WHTITLECLASS.PROJECTISBN, '') + '</projectisbn>'
              FROM WHTITLECLASS
              WHERE (WHTITLECLASS.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string

            --PRINT @lv_output_string

            /* ************************************* */
            /* * ALTERNATE PROJECT ISBN   * */
            /* ************************************* */

            SELECT @lv_output_string = '<alternateprojectisbn>' + isnull(WHTITLECLASS.ALTERNATEPROJECTISBN, '') + '</alternateprojectisbn>'
              FROM WHTITLECLASS
              WHERE (WHTITLECLASS.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ** MAIN SAMPLABLE FLAG ** */
            SELECT @lv_output_string = '<mainsamplableflag>' + isnull(WHBOOKMISC.BOOKMISCYESNO10 , '') + '</mainsamplableflag>'
              FROM WHBOOKMISC
              WHERE (WHBOOKMISC.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ** SAMPLABLE FLAG ** */

            SELECT @lv_output_string = '<samplableflag>' + isnull(WHBOOKMISC.BOOKMISCYESNO7, '') + '</samplableflag>'
            FROM WHBOOKMISC
            WHERE (WHBOOKMISC.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ** RELEASED TO ELOQUENCE ** */

            SELECT @lv_output_string = '<releasedtoeloquence>' + isnull(WHTITLEINFO.TITLERELEASEDTOELOQUENCEIND, '') + '</releasedtoeloquence>'
            FROM WHTITLEINFO
            WHERE (WHTITLEINFO.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ** PACK TYPE ** */

            SELECT @lv_output_string = '<packtype>' + isnull(WHBOOKMISC.BOOKMISCGENTABLETEXT1, '') + '</packtype>'
            FROM WHBOOKMISC
            WHERE (WHBOOKMISC.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ** WEB WEIGHT ** */

            SELECT @lv_output_string = '<webweight>' + isnull(WHTITLECUSTOM.CUSTOMDESC01, '') + '</webweight>'
            FROM WHTITLECUSTOM
            WHERE (WHTITLECUSTOM.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ** CONTRIBUTOR STATEMENT ** */
            SELECT @lv_output_string = '<contributorstatement><![CDATA[' + isnull(WHTITLEINFO.FULLAUTHORDISPLAYNAME, '') + ']]></contributorstatement>'
              FROM WHTITLEINFO
              WHERE (WHTITLEINFO.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /* ** EDITION STATEMENT ** */

            SELECT @lv_output_string = '<editionstatement>' + isnull(WHTITLECLASS.EDITION, '') + '</editionstatement>'
              FROM WHTITLECLASS
              WHERE (WHTITLECLASS.BOOKKEY = @i_bookkey)

            execute  sp_AppendToFile @FileName, @lv_output_string
            --PRINT @lv_output_string

            /*  Books Supported  */
            -- Build comment in data chunks
	    set @lv_output_string = '<othertext><d104>100</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 96, @FileName
	    set @lv_output_string = ']]></d102></othertext>'
	    execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>100</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 96), '') + ']]></d102></othertext>')

            --PRINT @lv_output_string

            /*  Brief Contents  */

            -- Build comment in data chunks
	    set @lv_output_string = '<othertext><d104>101</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 97, @FileName
	    set @lv_output_string = ']]></d102></othertext>'
	    execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>101</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 97), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Body copy  */
	    set @lv_output_string = '<othertext><d104>99</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 1, @FileName
	    set @lv_output_string = ']]></d102></othertext>'
	    execute  sp_AppendToFile @FileName, @lv_output_string
--         SELECT @lv_output_string = ('<othertext><d104>99</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 1), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Brief Features  */
	    set @lv_output_string = '<othertext><d104>98</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 69, @FileName
	    set @lv_output_string = ']]></d102></othertext>'
	    execute  sp_AppendToFile @FileName, @lv_output_string

      --      SELECT @lv_output_string = ('<othertext><d104>98</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 69), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Details/Specs  */
	    set @lv_output_string = '<othertext><d104>97</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 94, @FileName
	    set @lv_output_string = ']]></d102></othertext>'
	    execute  sp_AppendToFile @FileName, @lv_output_string
         --   SELECT @lv_output_string = ('<othertext><d104>97</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 94), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Excerpt  */
	    --Build comment in data chunks
	    set @lv_output_string = '<othertext><d104>23</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 5, @FileName
	    set @lv_output_string = ']]></d102></othertext>'
	    execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>23</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 5), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Featured Quote  */ 
	    set @lv_output_string = '<othertext><d104>95</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 78, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--	    Select '<othertext><d104>95</d104><d102><![CDATA[' || get_commenthtmllite(i_bookkey,3,78) || ']]></d102></othertext>'
            --PRINT @lv_output_string

            /*  Cat Features  */
	    set @lv_output_string = '<othertext><d104>94</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 77, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>94</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 77), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Letter From the Author  */
	    set @lv_output_string = '<othertext><d104>93</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 80, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>93</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 80), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Media  */
	    set @lv_output_string = '<othertext><d104>92</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 80, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
 --           SELECT @lv_output_string = ('<othertext><d104>92</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 81), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat New to this Edition  */
	    set @lv_output_string = '<othertext><d104>91</d104><d102><![CDATA['
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 82, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>91</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 82), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Parent Text  */ --hren check why 90 was skiped
	    set @lv_output_string = '<othertext><d104>89</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 84, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>89</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 84), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Picture  */
	    set @lv_output_string = '<othertext><d104>88</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 85, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>88</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 85), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Preview Materials  */
	    set @lv_output_string = '<othertext><d104>87</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 87, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>87</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 87), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat Supplements  */
	    set @lv_output_string = '<othertext><d104>86</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 91, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>86</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 91), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat URL Link  */
	    set @lv_output_string = '<othertext><d104>85</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 93, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>85</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 93), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. Brief Summary  */
	    set @lv_output_string = '<othertext><d104>102</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 70, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>102</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 70), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. FAQ  */
	    set @lv_output_string = '<othertext><d104>103</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 76, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>103</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 76), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. Offsite Link  */
	    set @lv_output_string = '<othertext><d104>104</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 83, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>104</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 83), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. Positioning Statement  */
	    set @lv_output_string = '<othertext><d104>105</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 86, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>105</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 86), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. Sample Chapters  */
	    set @lv_output_string = '<othertext><d104>106</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 89, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>106</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 89), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. Summary  */
	    set @lv_output_string = '<othertext><d104>107</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 90, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>107</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 90), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. SW Competition Description  */
	    set @lv_output_string = '<othertext><d104>108</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 71, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>108</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 71), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. SW Contact Information  */
	    set @lv_output_string = '<othertext><d104>109</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 72, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>109</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 72), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. SW Distribution  */
	    set @lv_output_string = '<othertext><d104>110</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 73, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>110</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 73), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. SW Installation Instructions  */
	    set @lv_output_string = '<othertext><d104>111</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 79, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>111</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 79), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. SW System Requirements  */
	    set @lv_output_string = '<othertext><d104>112</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 92, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>112</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 92), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Cat. What Reviewers are Saying  */
	    set @lv_output_string = '<othertext><d104>113</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 88, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>113</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 88), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Related Readings  */
	    set @lv_output_string = '<othertext><d104>114</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 98, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>114</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 98), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  Sampling  */
	    set @lv_output_string = '<othertext><d104>115</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 99, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>115</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 99), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  SW Demo Scripts  */
	    set @lv_output_string = '<othertext><d104>116</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 100, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>116</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 100), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  SW Downloads  */
	    set @lv_output_string = '<othertext><d104>117</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 74, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>117</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 74), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  WWW Author Bio  */
	    set @lv_output_string = '<othertext><d104>13</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 31, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>13</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 31), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  WWW Back Panel Copy  */
	    set @lv_output_string = '<othertext><d104>18</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 3, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>18</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 3), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  WWW Brief Description  */
	    set @lv_output_string = '<othertext><d104>02</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 39, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>02</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 39), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  WWW Description  */
	    set @lv_output_string = '<othertext><d104>102</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 6, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>118</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 6), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  WWW Excerpts  */
	    set @lv_output_string = '<othertext><d104>119</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 5, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>119</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 5), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  WWW Flap Copy  */
	    set @lv_output_string = '<othertext><d104>17</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 2, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>17</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 2), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  WWW Pack Contents  */
	    set @lv_output_string = '<othertext><d104>84</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 65, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--          SELECT @lv_output_string = ('<othertext><d104>84</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 65), '') + ']]></d102></othertext>')

            /*  WWW Quotes  */
	    set @lv_output_string = '<othertext><d104>120</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 40, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--            SELECT @lv_output_string = ('<othertext><d104>120</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 40), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  PM 07/12/06 CRM 4066 TOC Truncated in College XML feed */

            /*  Increased substring from (1,31000 to 1,31900) because bookkey 2471000 was being truncated             */
	    set @lv_output_string = '<othertext><d104>04</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 32, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--            SELECT @lv_output_string = ('<othertext><d104>04</d104><d102><![CDATA[' + isnull(SYSDB.SSMA.SUBSTR3_VARCHAR(dbo.get_commenthtmllite_function(@i_bookkey, 3, 32), 0, 31900), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /*  PM 07/19/06 CRM 4080 HBPUB - Add new commenttype (Cat. Preview URL) TMM and add to College WEBXML feed */
	    set @lv_output_string = '<othertext><d104>121</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 102, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--            SELECT @lv_output_string = ('<othertext><d104>121</d104><d102><![CDATA[' + isnull(dbo.get_commenthtmllite_function(@i_bookkey, 3, 102), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /* UTL_FILE.FFLUSH (lv_file_id_num,lv_output_string); */
            /*  PM 10/25/06 CRM 4360 HBPUB - Add Table of Contents to College XML Feed */
	    set @lv_output_string = '<othertext><d104>125</d104><d102><![CDATA[' 
	    execute  sp_AppendToFile @FileName, @lv_output_string
	    execute  dbo.append_htmllite_to_file @i_bookkey, 1, 3, 20, @FileName
            set @lv_output_string =  ']]></d102></othertext>'
            execute  sp_AppendToFile @FileName, @lv_output_string
--            SELECT @lv_output_string = ('<othertext><d104>125</d104><d102><![CDATA[' + isnull(SYSDB.SSMA.SUBSTR3_VARCHAR(dbo.get_commenthtmllite_function(@i_bookkey, 3, 20), 1, 31900), '') + ']]></d102></othertext>')
            --PRINT @lv_output_string

            /* ************************************* */

            /* ******** PRICE TYPE COMPOSITE ******* */

            /* ************************************* */

            BEGIN

              DECLARE 
                @cursor_row7$BESTPRICE$2 integer,
                @cursor_row7$CURRENCYTYPE$2 varchar(20),
                @cursor_row7$PRICETYPE$2 varchar(20)              

              DECLARE 
                book_price_cursor CURSOR LOCAL 
                 FOR 
                  SELECT isnull(p.FINALPRICE, p.BUDGETPRICE) AS BESTPRICE, c.DATADESC AS CURRENCYTYPE, t.DATADESC AS PRICETYPE
                    FROM BOOKPRICE p, CURRENCY_VIEW c, PRICETYPE_VIEW t
                    WHERE (((p.FINALPRICE IS NOT NULL) OR 
                                    (p.BUDGETPRICE IS NOT NULL)) AND 
                            (c.DATACODE = p.CURRENCYTYPECODE) AND 
                            (t.DATACODE = p.PRICETYPECODE) AND 
                            (p.BOOKKEY = @i_bookkey))
              

              OPEN book_price_cursor

              FETCH NEXT FROM book_price_cursor
                INTO @cursor_row7$BESTPRICE$2, @cursor_row7$CURRENCYTYPE$2, @cursor_row7$PRICETYPE$2


              /*****
              *  WARNING ORA2MS-4019: Value of @@FETCH_STATUS might be changed by previous FETCH operation on the other cursor(s), if these cursors are used simultaneously.
              *****/

              WHILE  NOT(@@FETCH_STATUS = -1)
                BEGIN

                  IF (@@FETCH_STATUS = -1)
                    BREAK 

                  SET @lv_output_string = '<price>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<pricetype>' + isnull(@cursor_row7$PRICETYPE$2, '') + '</pricetype>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<currencytype>' + isnull(@cursor_row7$CURRENCYTYPE$2, '') + '</currencytype>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<bestprice>' + isnull(CAST( @cursor_row7$BESTPRICE$2 AS varchar(20)), '') + '</bestprice>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = '</price>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  FETCH NEXT FROM book_price_cursor
                    INTO @cursor_row7$BESTPRICE$2, @cursor_row7$CURRENCYTYPE$2, @cursor_row7$PRICETYPE$2

                END

              CLOSE book_price_cursor

              DEALLOCATE book_price_cursor

            END

            IF (cursor_status(N'local', N'book_price_cursor') = 1)
              BEGIN
                CLOSE book_price_cursor
                DEALLOCATE book_price_cursor
              END

            /*  END PRICE TYPE COMPOSITE */

            /* ************************************* */

            /* ******** COURSE COMPOSITE ******* */

            /* ************************************* */

            /* cursor_row8 book_course_cursor */

            BEGIN

              DECLARE 
                @cursor_row8$CATEGORYDESCRIPTION$2 varchar(255),
                @cursor_row8$CATEGORYCODE$2 integer,
                @cursor_row8$CATEGORYEXTERNALCODE$2 varchar(20),
                @cursor_row8$SUBCATDESCRIPTION$2 varchar(255),
                @cursor_row8$SUBCATCODE$2 integer,
                @cursor_row8$SUBCATEXTERNALCODE$2 varchar(20),
                @cursor_row8$SUB2DESCRIPTION$2 varchar(255),
                @cursor_row8$SUB2CATCODE$2 integer,
                @cursor_row8$SUB2EXTERNALCODE$2 varchar(20)              

              DECLARE 
                book_course_cursor CURSOR LOCAL 
                 FOR 
                  SELECT DISTINCT 
                      BOOK_COURSE.CATEGORYDESCRIPTION, 
                      BOOK_COURSE.CATEGORYCODE, 
                      BOOK_COURSE.CATEGORYEXTERNALCODE, 
                      BOOK_COURSE.SUBCATDESCRIPTION, 
                      BOOK_COURSE.SUBCATCODE, 
                      BOOK_COURSE.SUBCATEXTERNALCODE, 
                      BOOK_COURSE.SUB2DESCRIPTION, 
                      BOOK_COURSE.SUB2CATCODE, 
                      BOOK_COURSE.SUB2EXTERNALCODE
                    FROM BOOK_COURSE
                    WHERE (BOOK_COURSE.BOOKKEY = @i_bookkey)
              

              OPEN book_course_cursor

              FETCH NEXT FROM book_course_cursor
                INTO 
                  @cursor_row8$CATEGORYDESCRIPTION$2, 
                  @cursor_row8$CATEGORYCODE$2, 
                  @cursor_row8$CATEGORYEXTERNALCODE$2, 
                  @cursor_row8$SUBCATDESCRIPTION$2, 
                  @cursor_row8$SUBCATCODE$2, 
                  @cursor_row8$SUBCATEXTERNALCODE$2, 
                  @cursor_row8$SUB2DESCRIPTION$2, 
                  @cursor_row8$SUB2CATCODE$2, 
                  @cursor_row8$SUB2EXTERNALCODE$2


              WHILE  NOT(@@FETCH_STATUS = -1)
                BEGIN

                  IF (@@FETCH_STATUS = -1)
                    BREAK 

                  SET @lv_output_string = '<discipline>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<disciplinedescription><![CDATA[' + isnull(@cursor_row8$CATEGORYDESCRIPTION$2, '') + ']]></disciplinedescription>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<disciplinecode>' + isnull(CAST( @cursor_row8$CATEGORYCODE$2 AS varchar(20)), '') + '</disciplinecode>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<coursedescription><![CDATA[' + isnull(@cursor_row8$SUBCATDESCRIPTION$2, '') + ']]></coursedescription>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<coursecode>' + isnull(CAST( @cursor_row8$SUBCATCODE$2 AS varchar(20)), '') + '</coursecode>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<courseexternalcode>' + isnull(@cursor_row8$SUBCATEXTERNALCODE$2, '') + '</courseexternalcode>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<typedescription><![CDATA[' + isnull(@cursor_row8$SUB2DESCRIPTION$2, '') + ']]></typedescription>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<typecode>' + isnull(CAST( @cursor_row8$SUB2CATCODE$2 AS varchar(20)), '') + '</typecode>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<typeexternalcode>' + isnull(@cursor_row8$SUB2EXTERNALCODE$2, '') + '</typeexternalcode>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = '</discipline>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  FETCH NEXT FROM book_course_cursor
                    INTO 
                      @cursor_row8$CATEGORYDESCRIPTION$2, 
                      @cursor_row8$CATEGORYCODE$2, 
                      @cursor_row8$CATEGORYEXTERNALCODE$2, 
                      @cursor_row8$SUBCATDESCRIPTION$2, 
                      @cursor_row8$SUBCATCODE$2, 
                      @cursor_row8$SUBCATEXTERNALCODE$2, 
                      @cursor_row8$SUB2DESCRIPTION$2, 
                      @cursor_row8$SUB2CATCODE$2, 
                      @cursor_row8$SUB2EXTERNALCODE$2

                END

              CLOSE book_course_cursor

              DEALLOCATE book_course_cursor

            END

            IF (cursor_status(N'local', N'book_course_cursor') = 1)
              BEGIN
                CLOSE book_course_cursor
                DEALLOCATE book_course_cursor
              END

            /*  END COURSE COMPOSITE */

            /* ************************************* */

            /* ******** PACK COMPOSITE ******* */

            /* ************************************* */

            BEGIN

              DECLARE 
                @cursor_row9$PARENTBOOKKEY$2 integer,
                @cursor_row9$CHILDBOOKKEY$2 integer,
                @cursor_row9$SORTORDER$2 integer,
                @cursor_row9$QUANTITY$2 integer              

              DECLARE 
                pack_cursor CURSOR LOCAL 
                 FOR 
                  SELECT 
                      BOOKFAMILY.PARENTBOOKKEY, 
                      BOOKFAMILY.CHILDBOOKKEY, 
                      BOOKFAMILY.SORTORDER, 
                      BOOKFAMILY.QUANTITY
                    FROM BOOKFAMILY
                    WHERE ((BOOKFAMILY.RELATIONCODE = 20001) AND 
                            (BOOKFAMILY.PARENTBOOKKEY = @i_bookkey))
                  ORDER BY BOOKFAMILY.SORTORDER
              

              OPEN pack_cursor

              FETCH NEXT FROM pack_cursor
                INTO 
                  @cursor_row9$PARENTBOOKKEY$2, 
                  @cursor_row9$CHILDBOOKKEY$2, 
                  @cursor_row9$SORTORDER$2, 
                  @cursor_row9$QUANTITY$2


              WHILE  NOT(@@FETCH_STATUS = -1)
                BEGIN

                  IF (@@FETCH_STATUS = -1)
                    BREAK 

                  SET @lv_output_string = '<pack>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<packparentkey>' + isnull(CAST( @cursor_row9$PARENTBOOKKEY$2 AS varchar(20)), '') + '</packparentkey>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<childkey>' + isnull(CAST( @cursor_row9$CHILDBOOKKEY$2 AS varchar(20)), '') + '</childkey>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<sortorder>' + isnull(CAST( @cursor_row9$SORTORDER$2 AS varchar(20)), '') + '</sortorder>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<quantity>' + isnull(CAST( @cursor_row9$QUANTITY$2 AS varchar(20)), '') + '</quantity>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = '</pack>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  FETCH NEXT FROM pack_cursor
                    INTO 
                      @cursor_row9$PARENTBOOKKEY$2, 
                      @cursor_row9$CHILDBOOKKEY$2, 
                      @cursor_row9$SORTORDER$2, 
                      @cursor_row9$QUANTITY$2

                END

              CLOSE pack_cursor

              DEALLOCATE pack_cursor

            END

            IF (cursor_status(N'local', N'pack_cursor') = 1)
              BEGIN
                CLOSE pack_cursor
                DEALLOCATE pack_cursor
              END

            /*  END PACK COMPOSITE */

            /* ************************************* */

            /* ******** KEYWORD COMPOSITE ******* */

            /* ************************************* */

            /*  cursor_row10 keyword_cursor */

            BEGIN

              DECLARE 
                @cursor_row10$CATEGORYDESCRIPTION$2 varchar(255),
                @cursor_row10$CATEGORYCODE$2 integer,
                @cursor_row10$CATEGORYEXTERNALCODE$2 varchar(20),
                @cursor_row10$SUBCATDESCRIPTION$2 varchar(255),
                @cursor_row10$SUBCATCODE$2 integer,
                @cursor_row10$SUBCATEXTERNALCODE$2 varchar(20)              

              DECLARE 
                keyword_cursor CURSOR LOCAL 
                 FOR 
                  SELECT 
                      BOOK_CONTENT_NOTES.CATEGORYDESCRIPTION, 
                      BOOK_CONTENT_NOTES.CATEGORYCODE, 
                      BOOK_CONTENT_NOTES.CATEGORYEXTERNALCODE, 
                      BOOK_CONTENT_NOTES.SUBCATDESCRIPTION, 
                      BOOK_CONTENT_NOTES.SUBCATCODE, 
                      BOOK_CONTENT_NOTES.SUBCATEXTERNALCODE
                    FROM BOOK_CONTENT_NOTES
                    WHERE (BOOK_CONTENT_NOTES.BOOKKEY = @i_bookkey)
                  ORDER BY BOOK_CONTENT_NOTES.SORTORDER
              

              OPEN keyword_cursor

              FETCH NEXT FROM keyword_cursor
                INTO 
                  @cursor_row10$CATEGORYDESCRIPTION$2, 
                  @cursor_row10$CATEGORYCODE$2, 
                  @cursor_row10$CATEGORYEXTERNALCODE$2, 
                  @cursor_row10$SUBCATDESCRIPTION$2, 
                  @cursor_row10$SUBCATCODE$2, 
                  @cursor_row10$SUBCATEXTERNALCODE$2


              WHILE  NOT(@@FETCH_STATUS = -1)
                BEGIN

                  IF (@@FETCH_STATUS = -1)
                    BREAK 

                  SET @lv_output_string = '<keyword>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<keyworddescription1><![CDATA[' + isnull(@cursor_row10$CATEGORYDESCRIPTION$2, '') + ']]></keyworddescription1>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<keywordcode1>' + isnull(CAST( @cursor_row10$CATEGORYCODE$2 AS varchar(20)), '') + '</keywordcode1>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<keywordexternalcode1>' + isnull(@cursor_row10$CATEGORYEXTERNALCODE$2, '') + '</keywordexternalcode1>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<keyworddescription2><![CDATA[' + isnull(@cursor_row10$SUBCATDESCRIPTION$2, '') + ']]></keyworddescription2>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<keywordcode2>' + isnull(CAST( @cursor_row10$SUBCATCODE$2 AS varchar(20)), '') + '</keywordcode2>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<keywordexternalcode2>' + isnull(@cursor_row10$SUBCATEXTERNALCODE$2, '') + '</keywordexternalcode2>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = '</keyword>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  FETCH NEXT FROM keyword_cursor
                    INTO 
                      @cursor_row10$CATEGORYDESCRIPTION$2, 
                      @cursor_row10$CATEGORYCODE$2, 
                      @cursor_row10$CATEGORYEXTERNALCODE$2, 
                      @cursor_row10$SUBCATDESCRIPTION$2, 
                      @cursor_row10$SUBCATCODE$2, 
                      @cursor_row10$SUBCATEXTERNALCODE$2

                END

              CLOSE keyword_cursor

              DEALLOCATE keyword_cursor

            END

            IF (cursor_status(N'local', N'keyword_cursor') = 1)
              BEGIN
                CLOSE keyword_cursor
                DEALLOCATE keyword_cursor
              END

            /*  END KEYWORD COMPOSITE */

            /* ************************************* */
            /* ******** MARKETING CLUSTER COMPOSITE ******* */
            /* ************************************* */

            BEGIN

              DECLARE 
                @cursor_row11$CATEGORYDESCRIPTION$2 varchar(255),
                @cursor_row11$CATEGORYCODE$2 integer,
                @cursor_row11$CATEGORYEXTERNALCODE$2 varchar(20),
                @cursor_row11$SUBCATDESCRIPTION$2 varchar(255),
                @cursor_row11$SUBCATCODE$2 integer,
                @cursor_row11$SUBCATEXTERNALCODE$2 varchar(20),
                @cursor_row11$SUBSHORTDESC varchar(255)              

              DECLARE 
                marketing_cluster_cursor CURSOR LOCAL 
                 FOR 
                  SELECT 
                      BOOK_MARKETING_CLUSTER.CATEGORYDESCRIPTION, 
                      BOOK_MARKETING_CLUSTER.CATEGORYCODE, 
                      BOOK_MARKETING_CLUSTER.CATEGORYEXTERNALCODE, 
                      BOOK_MARKETING_CLUSTER.SUBCATDESCRIPTION, 
                      BOOK_MARKETING_CLUSTER.SUBCATCODE, 
                      BOOK_MARKETING_CLUSTER.SUBCATEXTERNALCODE, 
                      BOOK_MARKETING_CLUSTER.SUBSHORTDESC
                    FROM BOOK_MARKETING_CLUSTER
                    WHERE (BOOK_MARKETING_CLUSTER.BOOKKEY = @i_bookkey)
                  ORDER BY BOOK_MARKETING_CLUSTER.SORTORDER
              

              OPEN marketing_cluster_cursor

              FETCH NEXT FROM marketing_cluster_cursor
                INTO 
                  @cursor_row11$CATEGORYDESCRIPTION$2, 
                  @cursor_row11$CATEGORYCODE$2, 
                  @cursor_row11$CATEGORYEXTERNALCODE$2, 
                  @cursor_row11$SUBCATDESCRIPTION$2, 
                  @cursor_row11$SUBCATCODE$2, 
                  @cursor_row11$SUBCATEXTERNALCODE$2, 
                  @cursor_row11$SUBSHORTDESC

              WHILE  NOT(@@FETCH_STATUS = -1)
                BEGIN

                  IF (@@FETCH_STATUS = -1)
                    BREAK 

                  SET @lv_output_string = '<marketingcluster>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<marketingclusterdescription1><![CDATA[' + isnull(@cursor_row11$CATEGORYDESCRIPTION$2, '') + ']]></marketingclusterdescription1>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<marketingclustercode1>' + isnull(CAST( @cursor_row11$CATEGORYCODE$2 AS varchar(20)), '') + '</marketingclustercode1>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<marketingclusterexternalcode1>' + isnull(@cursor_row11$CATEGORYEXTERNALCODE$2, '') + '</marketingclusterexternalcode1>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<marketingclusterdescription2><![CDATA[' + isnull(@cursor_row11$SUBCATDESCRIPTION$2, '') + ']]></marketingclusterdescription2>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<marketingclustercode2>' + isnull(CAST( @cursor_row11$SUBCATCODE$2 AS varchar(20)), '') + '</marketingclustercode2>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<marketingclustershort>' + isnull(@cursor_row11$SUBSHORTDESC, '') + '</marketingclustershort>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<marketingclusterexternalcode2>' + isnull(@cursor_row11$SUBCATEXTERNALCODE$2, '') + '</marketingclusterexternalcode2>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = '</marketingcluster>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  FETCH NEXT FROM marketing_cluster_cursor
                    INTO 
                      @cursor_row11$CATEGORYDESCRIPTION$2, 
                      @cursor_row11$CATEGORYCODE$2, 
                      @cursor_row11$CATEGORYEXTERNALCODE$2, 
                      @cursor_row11$SUBCATDESCRIPTION$2, 
                      @cursor_row11$SUBCATCODE$2, 
                      @cursor_row11$SUBCATEXTERNALCODE$2, 
                      @cursor_row11$SUBSHORTDESC

                END

              CLOSE marketing_cluster_cursor

              DEALLOCATE marketing_cluster_cursor

            END

            IF (cursor_status(N'local', N'marketing_cluster_cursor') = 1)
              BEGIN
                CLOSE marketing_cluster_cursor
                DEALLOCATE marketing_cluster_cursor
              END

            /*  END MARKETINCLUSTER COMPOSITE */

            BEGIN

              DECLARE 
                @cursor_row12$AUTHORKEY$2 integer,
                @cursor_row12$SORTORDER$2 integer,
                @cursor_row12$AUTHORTYPE$2 varchar(20),
                @cursor_row12$FIRSTNAME$2 varchar(100),
                @cursor_row12$FIRSTNAMEU$2 varchar(100),
                @cursor_row12$LASTNAME$2 varchar(100),
                @cursor_row12$LASTNAMEU$2 varchar(100),
                @cursor_row12$MIDDLENAME$2 varchar(100),
                @cursor_row12$MIDDLENAMEU$2 varchar(100),
                @cursor_row12$TITLE$2 varchar(255),
                @cursor_row12$TITLEU$2 varchar(255),
                @cursor_row12$AUTHORSUFFIX$2 varchar(20),
                @cursor_row12$AUTHORDEGREE$2 varchar(100),
                @cursor_row12$AFFNAME$2 varchar(100),
                @cursor_row12$AFFTITLE$2 varchar(200)              

              DECLARE 
                author_cursor CURSOR LOCAL 
                 FOR 
                  SELECT 
                      a.AUTHORKEY, 
                      b.SORTORDER, 
                      t.DATADESC AS AUTHORTYPE, 
                      a.FIRSTNAME, 
                      upper(a.FIRSTNAME) AS FIRSTNAMEU, 
                      a.LASTNAME, 
                      upper(a.LASTNAME) AS LASTNAMEU, 
                      a.MIDDLENAME, 
                      upper(a.MIDDLENAME) AS MIDDLENAMEU, 
                      a.TITLE, 
                      upper(a.TITLE) AS TITLEU, 
                      a.AUTHORSUFFIX, 
                      a.AUTHORDEGREE, 
                      af.AFFNAME, 
                      af.AFFTITLE
                    FROM BOOKAUTHOR b, AUTHORTY_VIEW t, AUTHOR a
                       LEFT JOIN AUTHORAFFILIATIONS af  ON (a.AUTHORKEY = af.AUTHORKEY)
                    WHERE ((a.AUTHORKEY = b.AUTHORKEY) AND 
                            (b.AUTHORTYPECODE = t.DATACODE) AND 
                            (b.BOOKKEY = @i_bookkey))
                  ORDER BY b.SORTORDER
              

              OPEN author_cursor

              FETCH NEXT FROM author_cursor
                INTO 
                  @cursor_row12$AUTHORKEY$2, 
                  @cursor_row12$SORTORDER$2, 
                  @cursor_row12$AUTHORTYPE$2, 
                  @cursor_row12$FIRSTNAME$2, 
                  @cursor_row12$FIRSTNAMEU$2, 
                  @cursor_row12$LASTNAME$2, 
                  @cursor_row12$LASTNAMEU$2, 
                  @cursor_row12$MIDDLENAME$2, 
                  @cursor_row12$MIDDLENAMEU$2, 
                  @cursor_row12$TITLE$2, 
                  @cursor_row12$TITLEU$2, 
                  @cursor_row12$AUTHORSUFFIX$2, 
                  @cursor_row12$AUTHORDEGREE$2, 
                  @cursor_row12$AFFNAME$2, 
                  @cursor_row12$AFFTITLE$2

              WHILE  NOT(@@FETCH_STATUS = -1)
                BEGIN

                  IF (@@FETCH_STATUS = -1)
                    BREAK 

                  SET @lv_output_string = '<contributor>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<authorkey>' + isnull(CAST( @cursor_row12$AUTHORKEY$2 AS varchar(20)), '') + '</authorkey>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<sortorder>' + isnull(CAST( @cursor_row12$SORTORDER$2 AS varchar(20)), '') + '</sortorder>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<authortype>' + isnull(@cursor_row12$AUTHORTYPE$2, '') + '</authortype>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<firstname><![CDATA[' + isnull(@cursor_row12$FIRSTNAME$2, '') + ']]></firstname>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<firstnameU><![CDATA[' + isnull(@cursor_row12$FIRSTNAMEU$2, '') + ']]></firstnameU>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<lastname><![CDATA[' + isnull(@cursor_row12$LASTNAME$2, '') + ']]></lastname>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<lastnameU><![CDATA[' + isnull(@cursor_row12$LASTNAMEU$2, '') + ']]></lastnameU>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<middlename><![CDATA[' + isnull(@cursor_row12$MIDDLENAME$2, '') + ']]></middlename>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<middlenameU><![CDATA[' + isnull(@cursor_row12$MIDDLENAMEU$2, '') + ']]></middlenameU>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<title><![CDATA[' + isnull(@cursor_row12$TITLE$2, '') + ']]></title>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<titleU><![CDATA[' + isnull(@cursor_row12$TITLEU$2, '') + ']]></titleU>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<b248><![CDATA[' + isnull(@cursor_row12$AUTHORSUFFIX$2, '') + ']]></b248>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<b242><![CDATA[' + isnull(@cursor_row12$AUTHORDEGREE$2, '') + ']]></b242>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<b045><![CDATA[' + isnull(@cursor_row12$AUTHORTYPE$2, '') + ']]></b045>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<AFFNAME><![CDATA[' + isnull(@cursor_row12$AFFNAME$2, '') + ']]></AFFNAME>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<AFFTITLE><![CDATA[' + isnull(@cursor_row12$AFFTITLE$2, '') + ']]></AFFTITLE>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = '</contributor>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  FETCH NEXT FROM author_cursor
                    INTO 
                      @cursor_row12$AUTHORKEY$2, 
                      @cursor_row12$SORTORDER$2, 
                      @cursor_row12$AUTHORTYPE$2, 
                      @cursor_row12$FIRSTNAME$2, 
                      @cursor_row12$FIRSTNAMEU$2, 
                      @cursor_row12$LASTNAME$2, 
                      @cursor_row12$LASTNAMEU$2, 
                      @cursor_row12$MIDDLENAME$2, 
                      @cursor_row12$MIDDLENAMEU$2, 
                      @cursor_row12$TITLE$2, 
                      @cursor_row12$TITLEU$2, 
                      @cursor_row12$AUTHORSUFFIX$2, 
                      @cursor_row12$AUTHORDEGREE$2, 
                      @cursor_row12$AFFNAME$2, 
                      @cursor_row12$AFFTITLE$2

                END

              CLOSE author_cursor

              DEALLOCATE author_cursor

            END

            IF (cursor_status(N'local', N'marketing_cluster_cursor') = 1)
              BEGIN
                CLOSE marketing_cluster_cursor
                DEALLOCATE marketing_cluster_cursor
              END

            /*  END AUTHOR COMPOSITE */

            /* ************************************* */

            /* ******** BISAC SUBJECT COMPOSITE ******* */

            /* ************************************* */

            BEGIN

              DECLARE 
                @cursor_row13$BOOKKEY$2 integer,
                @cursor_row13$MAJORBISACCATEGORYCODE$2 integer,
                @cursor_row13$MAJORBISACCATEGORYDESC$2 varchar(255),
                @cursor_row13$MINORBISACCATEGORYCODE$2 integer,
                @cursor_row13$MINORBISACCATEGORYDESC$2 varchar(255),
                @cursor_row13$SORTORDER$2 integer              

              DECLARE 
                bisacsubject_cursor CURSOR LOCAL 
                 FOR 
                  SELECT 
                      bs.BOOKKEY, 
                      g.DATACODE AS MAJORBISACCATEGORYCODE, 
                      g.DATADESC AS MAJORBISACCATEGORYDESC, 
                      sg.DATASUBCODE AS MINORBISACCATEGORYCODE, 
                      sg.DATADESC AS MINORBISACCATEGORYDESC, 
                      bs.SORTORDER
                    FROM BOOKBISACCATEGORY bs, GENTABLES g, SUBGENTABLES sg
                    WHERE ((g.TABLEID = 339) AND 
                            (sg.TABLEID = 339) AND 
                            (g.DATACODE = bs.BISACCATEGORYCODE) AND 
                            (g.DATACODE = sg.DATACODE) AND 
                            (sg.DATASUBCODE = bs.BISACCATEGORYSUBCODE) AND 
                            (bs.BOOKKEY = @i_bookkey))
                  ORDER BY bs.SORTORDER
              

              OPEN bisacsubject_cursor

              FETCH NEXT FROM bisacsubject_cursor
                INTO 
                  @cursor_row13$BOOKKEY$2, 
                  @cursor_row13$MAJORBISACCATEGORYCODE$2, 
                  @cursor_row13$MAJORBISACCATEGORYDESC$2, 
                  @cursor_row13$MINORBISACCATEGORYCODE$2, 
                  @cursor_row13$MINORBISACCATEGORYDESC$2, 
                  @cursor_row13$SORTORDER$2

              WHILE  NOT(@@FETCH_STATUS = -1)
                BEGIN

                  IF (@@FETCH_STATUS = -1)
                    BREAK 

                  SET @lv_output_string = '<bisacsubjects>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<majorbisaccategorycode>' + isnull(CAST( @cursor_row13$MAJORBISACCATEGORYCODE$2 AS varchar(20)), '') + '</majorbisaccategorycode>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<majorbisaccategorydesc><![CDATA[' + isnull(@cursor_row13$MAJORBISACCATEGORYDESC$2, '') + ']]></majorbisaccategorydesc>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<minorbisaccategorycode>' + isnull(CAST( @cursor_row13$MINORBISACCATEGORYCODE$2 AS varchar(20)), '') + '</minorbisaccategorycode>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<minorbisaccategorydesc><![CDATA[' + isnull(@cursor_row13$MINORBISACCATEGORYDESC$2, '') + ']]></minorbisaccategorydesc>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = ('<sortorder>' + isnull(CAST( @cursor_row13$SORTORDER$2 AS varchar(20)), '') + '</sortorder>')

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  SET @lv_output_string = '</bisacsubjects>'

                  execute  sp_AppendToFile @FileName, @lv_output_string

                  --PRINT @lv_output_string

                  FETCH NEXT FROM bisacsubject_cursor
                    INTO 
                      @cursor_row13$BOOKKEY$2, 
                      @cursor_row13$MAJORBISACCATEGORYCODE$2, 
                      @cursor_row13$MAJORBISACCATEGORYDESC$2, 
                      @cursor_row13$MINORBISACCATEGORYCODE$2, 
                      @cursor_row13$MINORBISACCATEGORYDESC$2, 
                      @cursor_row13$SORTORDER$2

                END

              CLOSE bisacsubject_cursor

              DEALLOCATE bisacsubject_cursor

            END

            IF (cursor_status(N'local', N'bisacsubject_cursor') = 1)
              BEGIN
                CLOSE bisacsubject_cursor
                DEALLOCATE bisacsubject_cursor
              END

            /*  END BISAC SUBJECT COMPOSITE COMPOSITE */

            IF (@d_usretail > 0)
              IF (cursor_status(N'local', N'bisac_cursor') = 1)
                BEGIN
                  CLOSE bisac_cursor
                  DEALLOCATE bisac_cursor
                END

            SET @i_count = 0

            SELECT @i_count = count( * )
              FROM BOOKSETS
              WHERE ((BOOKSETS.BOOKKEY = @i_bookkey) AND 
                      (BOOKSETS.SETTYPECODE IS NOT NULL))

            SET @i_settypecode = 0

            IF (@i_count > 0)
              BEGIN

                SELECT @i_settypecode = BOOKSETS.SETTYPECODE
                  FROM BOOKSETS
                  WHERE (BOOKSETS.BOOKKEY = @i_bookkey)

                SELECT @lv_output_string = ('<settype>' + isnull(dbo.GENTABLES_LONGDESC(481, @i_settypecode), '') + '</settype>')

                execute  sp_AppendToFile @FileName, @lv_output_string

                --PRINT @lv_output_string

              END

            /* ************************************* */

            /* * Output Product Group Ending Line  * */

            /* ************************************* */

            SET @lv_output_string = '</product>'

            execute  sp_AppendToFile @FileName, @lv_output_string

            --PRINT @lv_output_string

          END
      END
go
grant execute on webbookdetail_sp_college  to public
go
